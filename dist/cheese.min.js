/*! cheese.js - v1.0.0 - 2014-01-03
* http://lukejones.com/
* Copyright (c) 2014 Luke Jones; Licensed MIT */
var app=app||{};app.router=app.router||{},app.router.Router=Backbone.Router.extend({routes:{"":"home",inventory:"inventory",sources:"sources",source:"source","source/:id":"source",arrival:"arrival",createBatch:"createBatch",viewBatches:"viewBatches"},home:function(){new app.view.Home},inventory:function(){new app.view.Inventory,app.menu.context({id:"invMgmt",name:"Inventory Management"})},sources:function(){new app.view.Sources,app.menu.context({id:"sources",name:"Sources List"})},source:function(a){var b="Source";a?(new app.view.Source({id:a}),b="Edit "+b):(new app.view.Source,b="Add "+b),app.menu.context({id:"source",name:"Add Source"})},arrival:function(){new app.view.Arrival,app.menu.context({id:"arrival",name:"Arrivals"})},createBatch:function(){new app.view.CreateBatch},viewBatches:function(){new app.BatchListingView}}),app.model=app.model||{},app.model.Batch=Backbone.Model.extend({defaults:{notes:"",milks:{}},idAttribute:"result",url:"/api/batches",initialize:function(a){return"undefined"!=typeof a?(this.urlRoot="/api/batches/"+a,this.fetch()):void 0}}),app.model=app.model||{},app.model.Cheese=Backbone.Model.extend({defaults:{name:"cheese name",type_id:0,rennents:{},cultures:{},larges:0,mediums:0,smalls:0,batch_id:0},url:"/api/cheeses",initialize:function(a){return"undefined"!=typeof a?(this.urlRoot="/api/cheese/"+a,this.fetch()):void 0}}),app.model=app.model||{},app.model.CheeseType=Backbone.Model.extend({defaults:{name:"cheese name",description:""},idAttribute:"result"}),app.model=app.model||{},app.model.Culture=Backbone.Model.extend({defaults:{name:"culture name",description:""}}),app.model=app.model||{},app.model.Milk=Backbone.Model.extend({defaults:{name:"milk name",description:""},idAttribute:"result"}),app.model=app.model||{},app.model.Rennent=Backbone.Model.extend({defaults:{name:"rennent name",description:""}}),app.model=app.model||{},app.model.Source=Backbone.Model.extend({defaults:{},idAttribute:"result",initialize:function(a,b){return this.callback=b,"undefined"!=typeof a?(this.urlRoot="/api/sources/"+a,this.fetch()):void 0},parse:function(a){a.success?this.callback(null,a.result):this.callback(a.result,null)}}),app.collection=app.collection||{},app.collection.Batches=Backbone.Collection.extend({model:app.model.Batch,url:"/api/batches",parse:function(a){return a.success?a.result:(console.log("error with fetch Batches collection"),void 0)}}),app.collection=app.collection||{},app.collection.CheeseTypes=Backbone.Collection.extend({model:app.model.CheeseType,url:"/api/cheeseTypes",parse:function(a){return a.success?a.result:(console.log("error with fetch CheeseTypes collection"),void 0)}}),app.collection=app.collection||{},app.collection.Cheeses=Backbone.Collection.extend({model:app.model.Cheese,url:"/api/cheeses",parse:function(a){return a.success?a.result:(console.log("error with fetch Cheeses collection"),void 0)}}),app.collection=app.collection||{},app.collection.Cultures=Backbone.Collection.extend({model:app.model.Culture,url:"/api/cultures",parse:function(a){return a.success?a.result:(console.log("error with fetch Cultures collection"),void 0)}}),app.collection=app.collection||{},app.collection.Milks=Backbone.Collection.extend({model:app.model.Milk,url:"/api/milks",parse:function(a){return a.success?a.result:(console.log("error with fetch Sources collection"),void 0)}}),app.collection=app.collection||{},app.collection.Rennents=Backbone.Collection.extend({model:app.model.Rennent,url:"/api/rennents",parse:function(a){return a.success?a.result:(console.log("error with fetch Rennents collection"),void 0)}}),app.collection=app.collection||{},app.collection.Sources=Backbone.Collection.extend({model:app.model.Source,url:"/api/sources"}),app.view=app.view||{},app.view.Arrival=Backbone.View.extend({template:"arrival",milk_tmpl:"milk",el:$("#wrapper"),events:{"click #milk":"milk"},initialize:function(){this.render()},render:function(){var a=this;app.getTemplate(this.template,{}).done(function(b){$(a.el).html(b),$(document).tooltip(),$("button").button()})},milk:function(a){a.preventDefault();var b=$(a.currentTarget);b.hasClass("disabled")||(new app.view.Milk({append:!0}),b.addClass("disabled"))}}),app.BatchListingView=Backbone.View.extend({template:"batchListing",el:$("#wrapper"),events:{"click table.display tr":"rowClicked"},initialize:function(){app.batches.fetch({reset:!0}),this.listenTo(app.batches,"reset",this.render)},render:function(){var a=this,b=[],c=[];app.batches.each(function(a,d){var e=[];$.each(a.attributes,function(a,c){0==d&&b.push({sTitle:a}),e.push(c)}),c.push(e)}),app.getTemplate(this.template,{}).done(function(d){$(a.el).html(d),$("#table_wrapper").dataTable({bJQueryUI:!0,sPaginationType:"full_numbers",aaData:c,aoColumns:b})})},rowClicked:function(a){console.log(parseInt($(a.currentTarget).find("td").eq(0).html()))},renderBatch:function(a){var b=new app.BatchVatView({model:a}),c=$(".batchWrapper");c.append(b.render().el)}}),app.view=app.view||{},app.view.CreateBatch=Backbone.View.extend({template:"createBatchTmpl",$volumeAddTmpl:$("#batchVolumeAddTemplate"),el:$("#wrapper"),sources:1,cheeses:[],milkNames:[],cheeseNames:[],typeNames:[],cheeseIdx:0,events:{"click #addCheese":"addCheese","click #addBatch":"saveBatch"},initialize:function(){this.cheeseCollection=new app.collection.Cheeses,this.render()},setupNames:function(){var a=this;this.names.each(function(b){a.cheeseNames.push(b.get("title"))})},setupTypes:function(){var a=this;this.types.each(function(b){a.typeNames.push(b.get("title"))})},render:function(){var a=this;app.getTemplate(this.template,{}).done(function(b){$(a.el).html(b);var c=new Date,d="";d=app.getDate(c),$("#creation_date").attr("value",d);var e=new app.view.Milk;$.when(e.render()).then(function(){$(".batchInputs .sourcesDrop").menu(),e.setupMilks()})})},renderCheese:function(a){var b=new app.view.Cheese({model:a}),c=$(".batchWrapper"),d=b.render({cheeseIdx:this.cheeseIdx,types:this.typeNames,cheese:this.cheeseNames}).el;c.append(d),$("#large-"+this.cheeseIdx+", #medium-"+this.cheeseIdx+", #small-"+this.cheeseIdx).on("keyup",function(){var a,b=$(this).parent().parent().attr("data"),c=parseInt($("#large-"+b).val())||0,d=parseInt($("#medium-"+b).val())||0,e=parseInt($("#small-"+b).val())||0;a=c+d+e,$("#total-"+b).html(a)}),this.cheeseIdx+=1},addCheese:function(a){a.preventDefault();var b=new app.view.Cheese;$.when(b.render()).then(function(a){$(".batchWrapper").append(a),$(".cheeseDrop",a).menu(),$("#large, #medium, #small",a).on("keyup",function(){var b,c=parseInt($("#large",a).val())||0,d=parseInt($("#medium",a).val())||0,e=parseInt($("#small",a).val())||0;b=c+d+e,$("#total",a).html(b)}),b.setupCheeseTypes(),b.setupRennents(),b.setupCultures()})},saveBatch:function(){var a,b=this,c={};c.milks=[],$.each($(".autoSource"),function(a,b){c.milks.push({volume:$(".batchInputs").eq(a).find("input").eq(0).val(),milk_id:$(b).attr("data-idx")})}),c.notes=$("#notes").val(),a=app.batches.create(c,{success:function(){var c=a.id.batch_id;b.saveCheeses(c)}})},saveCheeses:function(a){var b=$(".batchWrapper").children(),c=this;$.each(b,function(b,d){var e={};e.name=$(d).find(".cheeseName").val(),e.type_id=$(d).find(".cheeseType").attr("data-idx"),e.rennents=[],$.each($(".cheeseRennent",$(d)),function(a,b){e.rennents.push($(b).attr("data-idx"))}),e.cultures=[],$.each($(".cheeseCulture",$(d)),function(a,b){e.cultures.push($(b).attr("data-idx"))}),e.largers=$(d).find("#large").val(),e.mediums=$(d).find("#medium").val(),e.smalls=$(d).find("#small").val(),e.batch_id=a,c.cheeseCollection.create(e)})}});var app=app||{};app.view.Cheese=Backbone.View.extend({template:"cheese",rennentTmpl:"rennentRow",cultureTmpl:"cultureRow",tagName:"li",cheeseTypeNames:[],rennentNames:[],cultureNames:[],events:{"click .deleteCheese":"deleteCheese","click .createRennent":"createRennent","click .createCulture":"createCulture","click .addRennent":"addRennent","click .addCulture":"addCulture","click .removeRennent":"removeRennent","click .removeCulture":"removeCulture","click .addCheeseType":"addCheeseType"},initialize:function(){},render:function(){var a=this;return app.getTemplate(this.template,{}).then(function(b){return $(a.el).html(b)})},setupCheeseTypes:function(){var a=this;0==this.cheeseTypeNames.length&&app.cheeseTypes.each(function(b){a.cheeseTypeNames.push(b.get("name"))}),$(".cheeseType",this.$el).autocomplete({source:this.cheeseTypeNames,select:function(a,b){var c,d;c=_.find(app.cheeseTypes.models,function(a){return a.get("name")==b.item.value}),d=c.get("type_id"),$(this).attr("data-idx",d)}})},setupRennents:function(){var a=this;0==this.rennentNames.length&&app.rennents.each(function(b){a.rennentNames.push(b.get("name"))}),$(".cheeseRennent",this.$el).autocomplete({source:this.rennentNames,select:function(a,b){var c,d;c=_.find(app.rennents.models,function(a){return a.get("name")==b.item.value}),d=c.get("rennent_id"),$(this).attr("data-idx",d)}})},setupCultures:function(){var a=this;0==this.cultureNames.length&&app.cultures.each(function(b){a.cultureNames.push(b.get("name"))}),$(".cheeseCulture",this.$el).autocomplete({source:this.cultureNames,select:function(a,b){var c,d;c=_.find(app.cultures.models,function(a){return a.get("name")==b.item.value}),d=c.get("culture_id"),$(this).attr("data-idx",d)}})},createRennent:function(a){a.preventDefault();var b=new app.view.RennentModal,c=this;$.when(b.render()).then(function(a){$(a).on("saved.rennent",function(a,b){$(".cheeseRennent",c.$el).val(b.name).attr("data-idx",b.milk_id)}),$("body").append(a)})},createCulture:function(a){a.preventDefault();var b=new app.view.CultureModal,c=this;$.when(b.render()).then(function(a){$(a).on("saved.culture",function(a,b){c.cultureNames.push(b.name),$(".cheeseCulture",c.$el).val(b.name).attr("data-idx",b.milk_id)}),$("body").append(a)})},addCulture:function(a){a.preventDefault();var b=$(a.currentTarget).parents(".cheeseDrop").siblings(".cultureWrapper"),c=this;app.getTemplate(this.cultureTmpl,{}).done(function(a){var d=$(a);$(".cheeseCulture",d).autocomplete({source:c.cultureNames,select:function(a,b){var c,d;c=_.find(app.cultures.models,function(a){return a.get("name")==b.item.value}),d=c.get("culture_id"),$(this).attr("data-idx",d)}}),b.append(d)})},addRennent:function(a){a.preventDefault();var b=$(a.currentTarget).parents(".cheeseDrop").siblings(".rennentWrapper"),c=this;app.getTemplate(this.rennentTmpl,{}).done(function(a){var d=$(a);$(".cheeseRennent",d).autocomplete({source:c.rennentNames,select:function(a,b){var c,d;c=_.find(app.rennents.models,function(a){return a.get("name")==b.item.value}),d=c.get("rennent_id"),$(this).attr("data-idx",d)}}),b.append(d)})},removeRennent:function(a){a.preventDefault();var b=$(a.currentTarget).parent();b.remove()},removeCulture:function(a){a.preventDefault();var b=$(a.currentTarget).parent();b.remove()},addCheeseName:function(a){a.preventDefault();var b=new app.view.CheeseNameModal;$.when(b.render()).then(function(a){$("body").append(a)})},addCheeseType:function(a){a.preventDefault();var b=new app.view.CheeseTypeModal,c=this;$.when(b.render()).then(function(a){$(a).on("saved.type",function(a,b){c.cheeseTypeNames.push(b.name),$(".cheeseType",c.$el).val(b.name).attr("data-idx",b.milk_id)}),$("body").append(a)})},deleteCheese:function(a){a.preventDefault(),this.remove()}}),app.view=app.view||{},app.view.Culture=Backbone.View.extend({template:"culture",el:$("#wrapper"),options:{},events:{"click #save":"save","click #clear":"clear"},initialize:function(a){this.options=a||{},this.render()},render:function(){var a=this;app.getTemplate(this.template,{}).done(function(b){a.options.append?$(a.el).append(b):$(a.el).html(b),$(document).tooltip(),$("button").button(),$("#date").datetimepicker()})},clear:function(a){a.preventDefault(),$("input").val(""),$("select").val("select"),$("textarea").val("")},save:function(a){a.preventDefault();var b={};b.source=$("#source").val(),b.date=$("#date").val(),b.temp=$("#temp").val(),b.amount=$("#amount").val(),b.notes=$("#notes").val()}}),app.view=app.view||{},app.view.Home=Backbone.View.extend({template:"home",el:$("#wrapper"),events:{"click #invMgmt":"inventory"},initialize:function(){this.render()},render:function(){var a=this;app.getTemplate(this.template,{}).done(function(b){$(a.el).html(b),$("button").button()})},inventory:function(a){a.preventDefault(),app.router.inst.navigate("inventory",{trigger:!0})}}),app.view=app.view||{},app.view.Inventory=Backbone.View.extend({template:"inventory",el:$("#wrapper"),events:{"click #sources":"sources","click #arrival":"arrival"},initialize:function(){this.render()},render:function(){var a=this;app.getTemplate(this.template,{}).done(function(b){$(a.el).html(b),$(document).tooltip(),$("button").button()})},sources:function(a){a.preventDefault(),app.router.inst.navigate("sources",{trigger:!0})},arrival:function(a){a.preventDefault(),app.router.inst.navigate("arrival",{trigger:!0})}}),app.view=app.view||{},app.view.Menu=Backbone.View.extend({template:"menu",row:_.template('<li id="<%= id %>" class="current"><%= name %></li>'),el:$("header"),events:{"click #home":"home","click #invMgmt":"inventory","click #sources":"sources"},initialize:function(){this.render()},render:function(){var a=this;app.getTemplate(this.template,{}).done(function(b){$(a.el).html(b),$("button").button()})},context:function(a){$(".current").removeClass("current"),$(".breadcrumbs-one").append(this.row(a))},home:function(a){a.preventDefault();var b=$(a.currentTarget);b.nextAll("li").remove(),app.router.inst.navigate("",{trigger:!0})},inventory:function(a){a.preventDefault();var b=$(a.currentTarget);b.nextAll("li").remove(),b.remove(),app.router.inst.navigate("inventory",{trigger:!0})},sources:function(a){a.preventDefault();var b=$(a.currentTarget);b.nextAll("li").remove(),b.remove(),app.router.inst.navigate("sources",{trigger:!0})}}),app.view=app.view||{},app.view.Milk=Backbone.View.extend({template:"milk",el:$("#wrapper"),options:{},events:{"click #save":"save","click #clear":"clear"},initialize:function(a){this.options=a||{},this.render()},render:function(){var a=this;app.getTemplate(this.template,{}).done(function(b){a.options.append?$(a.el).append(b):$(a.el).html(b),$(document).tooltip(),$("button").button(),$("#date").datetimepicker()})},clear:function(a){a.preventDefault(),$("input").val(""),$("select").val("select"),$("textarea").val("")},save:function(a){a.preventDefault();var b,c={};c.source=$("#source").val(),c.date=$("#date").val(),c.temp=$("#temp").val(),c.amount=$("#amount").val(),c.notes=$("#notes").val(),b=app.milks.create(c,{success:function(){console.log(b)}})}}),app.view=app.view||{},app.view.Rennent=Backbone.View.extend({template:"rennent",el:$("#wrapper"),options:{},events:{"click #save":"save","click #clear":"clear"},initialize:function(a){this.options=a||{},this.render()},render:function(){var a=this;app.getTemplate(this.template,{}).done(function(b){a.options.append?$(a.el).append(b):$(a.el).html(b),$(document).tooltip(),$("button").button(),$("#date").datetimepicker()})},clear:function(a){a.preventDefault(),$("input").val(""),$("select").val("select"),$("textarea").val("")},save:function(a){a.preventDefault();var b={};b.source=$("#source").val(),b.date=$("#date").val(),b.temp=$("#temp").val(),b.amount=$("#amount").val(),b.notes=$("#notes").val()}}),app.view=app.view||{},app.view.Source=Backbone.View.extend({template:"source",el:$("#wrapper"),options:{},source:null,events:{"click #clear":"clear","click #save":"save","click #update":"update","keyup .autotab":"jump"},initialize:function(a){this.options=a,this.render()},render:function(){var a=this;this.options?this.source=new app.model.Source(this.options.id,function(b,c){if(b)console.log(b);else if(c.length){var d=c.pop();switch(d.update=!0,d.type){case 1:d.milk=!0}10==d.phone.length?(d.pstart=d.phone.substring(0,3),d.pmid=d.phone.substring(3,6),d.pend=d.phone.substring(6,10)):d.phone=!1,a.display(d)}else a.display({})}):this.display({})},display:function(a){var b=this;app.getTemplate(this.template,a).done(function(a){$(b.el).html(a),$(document).tooltip(),$("button").button()})},jump:function(a){a.preventDefault();var b=$(a.currentTarget),c=b.attr("maxlength"),d=b.val().length;d>=c&&b.next().focus()},clear:function(a){a.preventDefault(),$("input").val(""),$("select").val("select"),$("textarea").val("")},save:function(a){a.preventDefault();var b,c={};c.name=$("#name").val(),c.fullname=$("#cname").val(),c.source=parseInt($("#source").val()),c.phone=$("#phone_start").val()+$("#phone_mid").val()+$("#phone_end").val(),c.email=$("#email").val(),c.address=$("#address").val(),c.notes=$("#notes").val(),b=app.sources.create(c,{success:function(){window.history.back()}})},update:function(a){a.preventDefault();var b={};b.name=$("#name").val(),b.fullname=$("#cname").val(),b.source=parseInt($("#source").val()),b.phone=$("#phone_start").val()+$("#phone_mid").val()+$("#phone_end").val(),b.email=$("#email").val(),b.address=$("#address").val(),b.notes=$("#notes").val(),this.source.save(b)}}),app.view=app.view||{},app.view.Sources=Backbone.View.extend({template:"sources",el:$("#wrapper"),events:{"click #add":"add","click table.display tr":"edit"},initialize:function(){app.sources.fetch({reset:!0}),this.listenTo(app.sources,"reset",this.render)},render:function(){var a=this,b=[],c=[];app.sources.each(function(a,d){var e=[];$.each(a.attributes,function(a,c){0==d&&b.push({sTitle:a}),e.push(c)}),c.push(e)}),app.getTemplate(this.template,{}).done(function(d){$(a.el).html(d),$("#table_wrapper").dataTable({bJQueryUI:!0,sPaginationType:"full_numbers",aaData:c,aoColumns:b}),$("button").button()})},add:function(a){a.preventDefault(),app.router.inst.navigate("source",{trigger:!0})},edit:function(a){a.preventDefault();var b=parseInt($(a.currentTarget).find("td").eq(0).html());app.router.inst.navigate("source/"+b,{trigger:!0})}}),app.view=app.view||{},app.view.CheeseNameModal=Backbone.View.extend({template:"createCheese",tagName:"div",className:"modal",events:{"click .saveModal":"save","click .cancelModal":"cancel"},initialize:function(){},render:function(){var a=this;return app.getTemplate(this.template,{}).then(function(b){return $(a.el).html(b)})},save:function(){},cancel:function(){this.$el.remove()}}),app.view=app.view||{},app.view.CheeseTypeModal=Backbone.View.extend({template:"createCheeseType",tagName:"div",className:"modal",events:{"click .saveModal":"save","click .cancelModal":"cancel"},initialize:function(){_.bindAll(this,"save","remove")},render:function(){var a=this;return app.getTemplate(this.template,{}).then(function(b){return $(a.el).html(b)})},save:function(){var a,b,c,d=this;a=$(".modalName input",this.$el).val(),b=$(".modalDescription textarea",this.$el).val(),c=app.cheeseTypes.create({name:a,description:b},{success:function(){d.$el.trigger("saved.type",{name:c.id.name})}}),_.delay(this.remove,1e3)},cancel:function(){this.$el.remove()}}),app.view=app.view||{},app.view.CultureModal=Backbone.View.extend({template:"createCulture",tagName:"div",className:"modal",events:{"click .saveModal":"save","click .cancelModal":"cancel"},initialize:function(){},render:function(){var a=this;return app.getTemplate(this.template,{}).then(function(b){return $(a.el).html(b)})},save:function(){var a,b;a=$(".modalName input",this.$el).val(),b=$(".modalDescription textarea",this.$el).val(),app.cultures.create({name:a,description:b}),_.delay(this.$el.remove,1e3)},cancel:function(){this.$el.remove()}}),app.view=app.view||{},app.view.MilkModal=Backbone.View.extend({template:"createMilk",tagName:"div",className:"modal",events:{"click .saveModal":"save","click .cancelModal":"cancel"},initialize:function(){_.bindAll(this,"save","remove")},render:function(){var a=this;return app.getTemplate(this.template,{}).then(function(b){return $(a.el).html(b)})},save:function(){var a,b,c,d=this;a=$(".modalName input",this.$el).val(),b=$(".modalDescription textarea",this.$el).val(),c=app.milks.create({name:a,description:b},{success:function(){d.$el.trigger("saved.milk",{name:c.id.name,milk_id:c.id.milk_id})}}),_.delay(this.remove,1e3)},cancel:function(){this.$el.remove()}}),app.view=app.view||{},app.view.RennentModal=Backbone.View.extend({template:"createRennent",tagName:"div",className:"modal",events:{"click .saveModal":"save","click .cancelModal":"cancel"},initialize:function(){},render:function(){var a=this;return app.getTemplate(this.template,{}).then(function(b){return $(a.el).html(b)})},save:function(){var a,b;a=$(".modalName input",this.$el).val(),b=$(".modalDescription textarea",this.$el).val(),app.rennents.create({name:a,description:b}),_.delay(this.$el.remove,1e3)},cancel:function(){this.$el.remove()}}),function(){app.getDate=function(a){return a=a.getUTCFullYear()+"-"+("00"+(a.getUTCMonth()+1)).slice(-2)+"-"+("00"+a.getUTCDate()).slice(-2)+" "+("00"+a.getUTCHours()).slice(-2)+":"+("00"+a.getUTCMinutes()).slice(-2)+":"+("00"+a.getUTCSeconds()).slice(-2)},app.getTemplate=function(a,b){return $.get("js/app/templates/"+a+".hbs").then(function(a){return Handlebars.compile(a)(b)}).fail(function(a){console.log(a)})},app.sources=new app.collection.Sources,app.menu=new app.view.Menu,app.router.inst=new app.router.Router,Backbone.history.start()}();